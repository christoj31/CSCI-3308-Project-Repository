<div class="container mt-5">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Job ID</th>
                <th>Job Name</th>
                {{!-- <th>Company</th> --}}
                <th>Job Link</th>
                <th>Due Date</th>
                {{!-- <th>Point of Contact</th> <!--TODO: add point of contact tooltip (Christo)-->
                <th>Contact Log</th>
                <th>Meeting Log</th>
                <th>Target Location</th>
                <th>Department</th> --}}
                <th>Status</th>
                <th>Countdown</th>
                <th>Edit</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {{#each results}}
            <tr>
                <td>{{jobid}}</td>
                <td>{{jobtitle}}</td>
                <td><a class="link link-secondary link-hover" href="{{jobapplicationlink}}">{{jobapplicationlink}}</a></td>
                <td>{{due_date_string}}</td>
                  
                <!-- Status Column with Dropdown Button -->
                                <td>
                        <div class="relative inline-block">
                       {{#if (eq applicationstepid 1)}}
                        <span class="badge badge-success badge-xl text-lg py-3 px-5">Applied</span>
                        {{else if (eq applicationstepid 2)}}
                        <span class="badge badge-info badge-xl text-lg py-3 px-5">Not Applied</span>
                        {{else if (eq applicationstepid 3)}}
                        <span class="badge badge-primary badge-xl text-lg py-3 px-5">Accepted</span>
                        {{else if (eq applicationstepid 4)}}
                        <span class="badge badge-error badge-xl text-lg py-3 px-5">Declined</span>
                        {{else}}
                        <span class="badge badge-warning badge-xl text-lg py-3 px-5">Unknown</span>
                        {{/if}}
                    </div>
                </td>

                <td>
                    <div class="grid auto-cols-max grid-flow-col gap-5 text-center">
                        <div class="bg-primary rounded-box flex flex-col p-2">
                            <span class="countdown text-3xl">
                            <span style="--value:{{countdown}};"></span>
                            </span>
                            days
                        </div>
                    </div>
                </td>

                <td>
                    <div class="grid auto-cols-max grid-flow-col gap-5 text-center">
                            <button class="btn btn-outline btn-secondary"
                                onclick="editModal(this)"
                                data-jobid="{{jobid}}"
                                data-jobtitle="{{jobtitle}}"
                                data-joblink="{{jobapplicationlink}}"
                                data-due_date="{{due_date}}"
                                data-status="{{applicationstepid}}">
                                Edit
                            </button>        
                    </div>        
                </td>

                <td>
                    <div class="grid auto-cols-max grid-flow-col gap-5 text-center">
                        <button class="btn btn-outline btn-secondary"
                            <button id="delete-modal"
                                class="btn btn-secondary"
                                onclick="deleteModal(this)"
                                data-jobid="{{jobid}}">
                                ✕
                            </button>
                    </button>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</div>

<dialog id="edit_modal" class="modal">
    <div class="modal-box">
    <form method="dialog">
    <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
    </form>
    <h3 class="text-lg font-bold text-center">Edit Event:</h3>
    <form action="/editModal" method="POST">
    <div class="form-group">
            <input ctype="text" class="input input-bordered w-full" id="jobid" name="jobid" style="display: none;">
        </div>
        <div class="form-label" style="display: none;">
            <label for="jobid">jobid:</label>
        </div>
        <div class="form-group">
            <input ctype="text" class="input input-bordered w-full" id="jobid_holder" name="jobid_holder" disabled>
        </div>
        <div class="form-label">
            <label for="jobid_holder">Job ID:</label>
        </div>
        <div class="form-group">
            <input ctype="text" class="input input-bordered w-full" id="edit_job_name" name="job_name" placeholder="enter the job name...">
        </div>
        <div class="form-label">
            <label for="job_name">Job Name:</label>
        </div>
        <div class="form-group">
            <input type="link" class="input input-bordered w-full" id="edit_job_link" name="job_link" placeholder="enter the job link...">
        </div>
        <div class="form-label">
            <label for="job link">Job Link:</label>
        </div>
        <div class="form-group">
            <input type="date" class="input input-bordered w-full" id="edit_due_date" name="due_date" placeholder="2024-11-14" required>
        </div>
        <div class="form-label">
            <label for="due_date">Due Date:</label>
        </div>

        <div class="form-group">
            <select class="input input-bordered w-full" id="edit_status" name="status">
                <option>Select Status...</option>
                <option value="applied">Applied</option>
                <option value="not-applied">Not Applied</option>
                <option value="accepted">Accepted</option>
                <option value="denied">Denied</option>
            </select>
        </div>
        <div class="form-label" style="padding-bottom: 15px;">
            <label for="status">Status:</label>
        </div>
    
        <button type="submit" class="btn btn-primary" style="float: right; padding: 15px 32px;">Update</button>
    </form>
        <div style="padding-top: 20px">
            <form method="dialog">
                <button class="btn btn-secondary" style="float: right; margin-right: 5px;">Close</button>
            </form>
        </div>
    </div>
</dialog>

<script>

    // Function for opening the edit modal
    function editModal(button) {
        console.log('EDITMODAL FUNCTION ENTERED');
        const jobId = button.getAttribute('data-jobid');
        const jobTitle = button.getAttribute('data-jobtitle');
        const jobLink = button.getAttribute('data-joblink');
        const status = button.getAttribute('data-status');
        let newstatus = 0;
        console.log('EARLY STATUS: ', status);
        switch(status) {
            case 0: 
                newstatus = 'none';
                break;
            case '1': 
                newstatus = 'applied';
                break;
            case '2': 
                newstatus = 'not-applied';
                break;
            case '3': 
                newstatus = 'accepted';
                break;
            case '4': 
                newstatus = 'denied';
                break;
        }

        document.getElementById('jobid').value = jobId;
        document.getElementById('jobid_holder').value = jobId;
        document.getElementById('edit_job_name').value = jobTitle;
        document.getElementById('edit_job_link').value = jobLink;
        document.getElementById('edit_status').value = newstatus;

        document.getElementById('selectedStatus').value = newstatus;

        document.getElementById('edit_modal').showModal();
    }

// Select all dropdown options
const dropdownOptions = document.querySelectorAll('.dropdown-option');
const statusButtonText = document.querySelector('.statusButtonText');
const selectedStatusDisplay = document.getElementById('selectedStatus');

// Add click event listeners to each option
dropdownOptions.forEach(option => {
  option.addEventListener('click', async (event) => {
    event.preventDefault();  // Prevents default anchor behavior

    // Get the selected text
    const selectedStatusDisplay = event.target.textContent;
    console.log('SELECTED STATUS: ', selectedStatusDisplay);

    const getjobidquery = 'SELECT jobid FROM jobs';
    // Display the selected status (or handle as needed)
    //document.getElementById('selectedStatus').textContent = `Selected Status: ${selectedStatus}`;
    //console.log('NEW STATUS: ', `Selected Status: ${selectedStatus}`)
    
    // Optionally, you could also hide the dropdown here if needed
    //document.querySelector('.status-dropdown').classList.add('hidden');
  });
});

   // Update status badge on selection
    document.querySelectorAll('.dropdown-option').forEach(option => {
        option.addEventListener('click', async function (event) {
            event.preventDefault();

            const button = this.closest('.relative').querySelector('.status-button');
            const dropdown = this.closest('.status-dropdown');
            const jobId = button.closest('tr').querySelector('td:first-child').textContent.trim(); // Job ID
            const newStatus = this.textContent.trim();

            // Update badge
            const badge = button.closest('td').querySelector('.badge');
            if (badge) {
                if (newStatus === "Applied") {
                    badge.className = "badge badge-success badge-lg";
                    badge.textContent = "Applied";
                } else if (newStatus === "Not Applied") {
                    badge.className = "badge badge-info badge-lg";
                    badge.textContent = "Not Applied";
                } else if (newStatus === "Accepted") {
                    badge.className = "badge badge-primary badge-lg";
                    badge.textContent = "Accepted";
                } else if (newStatus === "Declined") {
                    badge.className = "badge badge-error badge-lg";
                    badge.textContent = "Declined";
                }
            }

            // Hide dropdown
            dropdown.classList.add('hidden');

            // Send updated status to the server
            try {
                const response = await fetch(`/update-status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jobId, status: newStatus }),
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Failed to update status');
                }

                console.log(`Status for Job ID ${jobId} updated to ${newStatus}`);
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update status. Please try again.');
            }
        });
    });

function deleteModal(button){
    console.log("deleteModal passed");
    const delJobID = button.getAttribute('data-jobid');
    {{!-- console.log("Job ID: ", delJobID); --}}


    const confirmation = confirm(`Are you sure you want to delete job ID: ${delJobID}?`);
    if (confirmation) {
        fetch(`/delete-job`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ jobID: delJobID })
        })
        .then(response => response.json())
        .then(data => {
            if(data.message === 'Job successfully deleted') {
                alert(`Job with ID ${delJobID} has been successfully deleted.`);
                button.closest('tr').remove();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting job:', error);
            alert('An error occurred while deleting the job.');
        });
    }
}

</script>